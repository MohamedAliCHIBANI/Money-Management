name: Backend CI - Unit Tests

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    steps:
      # 1. Récupération du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3. Installer dépendances
      - name: Install backend dependencies
        run: |
          cd backend-mongodb
          npm install

      # 4. Créer dossier rapport JUnit
      - name: Ensure report directory exists
        run: mkdir -p backend-mongodb/reports/junit

      # 5. Lancer les tests
      - name: Run unit tests
        run: |
          cd backend-mongodb
          npm test

      # 6. Vérification des rapports
      - name: Verify JUnit report exists
        run: |
          ls -lah backend-mongodb/reports/junit
          head -n 10 backend-mongodb/reports/junit/junit.xml

      # 7. Authentification Xray
      - name: Authenticate to Xray Cloud
        run: |
          set -e
          echo "Authentification Xray..."

          curl -s \
            -H "Content-Type: application/json" \
            -X POST https://xray.cloud.getxray.app/api/v2/authenticate \
            -d "{\"client_id\":\"${{ secrets.XRAY_CLIENT_ID }}\",\"client_secret\":\"${{ secrets.XRAY_CLIENT_SECRET }}\"}" \
            -o /tmp/xray_token.json

          TOKEN=$(cat /tmp/xray_token.json | tr -d '"')

          if [ -z "$TOKEN" ]; then
            echo "❌ ERREUR : Token Xray vide"
            exit 1
          fi

          echo "$TOKEN" > /tmp/xray_token.txt
          echo "✅ Token Xray reçu"

      # 8. Envoi du rapport JUnit à Xray
      - name: Upload JUnit results to Xray (MMT)
        run: |
          set -e
          TOKEN=$(cat /tmp/xray_token.txt)

          echo "Upload vers Xray (projectKey=MMT)..."

          curl --fail --retry 5 --retry-connrefused --retry-delay 3 \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/xml" \
            -X POST \
            "https://xray.cloud.getxray.app/api/v2/import/execution/junit?projectKey=MMT" \
            --data @"$GITHUB_WORKSPACE/backend-mongodb/reports/junit/junit.xml"

          echo "✅ Import Xray terminé pour le projet MMT"

      # 9. Sauvegarde du rapport JUnit comme artefact
      - name: Upload JUnit as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: junit-backend-report
          path: backend-mongodb/reports/junit/*.xml
          if-no-files-found: warn
