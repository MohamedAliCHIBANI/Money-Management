name: Backend CI - Unit Tests (DEBUG Xray)

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout du repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3. Install deps
      - name: Install backend dependencies
        run: |
          cd backend-mongodb
          npm install

      # 4. CrÃ©er dossier rapports
      - name: Ensure report directory exists
        run: mkdir -p backend-mongodb/reports/junit

      # 5. Lancer tests
      - name: Run unit tests
        run: |
          cd backend-mongodb
          npm test

      # 6. VÃ©rifier fichiers gÃ©nÃ©rÃ©s
      - name: Verify JUnit report exists
        run: |
          echo "ðŸ“‚ Contenu du dossier reports/junit :"
          ls -lah backend-mongodb/reports/junit || true

          echo "ðŸ“„ Preview fichier junit.xml :"
          head -n 20 backend-mongodb/reports/junit/junit.xml || true

      # 7. VÃ©rifier secrets (sans les afficher)
      - name: Check secrets presence
        run: |
          if [ -z "${{ secrets.XRAY_CLIENT_ID }}" ]; then
            echo "âŒ XRAY_CLIENT_ID manquant"
            exit 1
          fi
          if [ -z "${{ secrets.XRAY_CLIENT_SECRET }}" ]; then
            echo "âŒ XRAY_CLIENT_SECRET manquant"
            exit 1
          fi
          echo "âœ… Secrets prÃ©sents"

      # 8. Test de connexion Xray
      - name: Authenticate to Xray Cloud (DEBUG)
        run: |
          set -e

          echo "ðŸ” Authentification Xray Cloud..."
          
          curl -sv -H "Content-Type: application/json" \
            -X POST https://xray.cloud.getxray.app/api/v2/authenticate \
            -d "{\"client_id\":\"${{ secrets.XRAY_CLIENT_ID }}\",\"client_secret\":\"${{ secrets.XRAY_CLIENT_SECRET }}\"}" \
            -o /tmp/auth_response.json

          echo "ðŸ§¾ RÃ©ponse brute Xray AUTH :"
          cat /tmp/auth_response.json

          TOKEN=$(cat /tmp/auth_response.json | tr -d '"')

          if [ -z "$TOKEN" ]; then
            echo "âŒ TOKEN vide - Ã©chec authentification"
            exit 1
          fi

          echo "âœ… Token reÃ§u"
          echo "$TOKEN" > /tmp/xray_token.txt_
