name: Backend CI - Unit Tests

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install backend dependencies
        run: |
          cd backend-mongodb
          npm install

      - name: Ensure report directory exists
        run: mkdir -p backend-mongodb/reports/junit

      - name: Run unit tests
        run: |
          cd backend-mongodb
          npm test

      - name: Upload test report (JUnit)
        uses: actions/upload-artifact@v4
        with:
          name: junit-backend-report
          path: backend-mongodb/reports/junit/*.xml
          if-no-files-found: warn
      - name: Authenticate with Xray Cloud
        id: xray-auth
        run: |
          TOKEN=$(curl -s -H "Content-Type: application/json" \
            -X POST https://xray.cloud.getxray.app/api/v2/authenticate \
            -d "{\"client_id\":\"${{ secrets.XRAY_CLIENT_ID }}\",\"client_secret\":\"${{ secrets.XRAY_CLIENT_SECRET }}\"}")

          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Send report to Xray
        run: |
          curl -H "Content-Type: application/xml" \
               -H "Authorization: Bearer ${{ steps.xray-auth.outputs.token }}" \
               -X POST \
               https://xray.cloud.getxray.app/api/v2/import/execution/junit \
               --data @$GITHUB_WORKSPACE/backend-mongodb/reports/junit/report.xml


